"use strict";function filterOutCallbacks(e){var r=_.clone(e)||{};return delete r.success,delete r.error,r}var _=require("underscore");module.exports=function(e){e.User=e.Object.extend("_User",{_isCurrentUser:!1,_mergeMagicFields:function(r){r.sessionToken&&(this._sessionToken=r.sessionToken,delete r.sessionToken),e.User.__super__._mergeMagicFields.call(this,r)},_cleanupAuthData:function(){if(this.isCurrent()){var r=this.get("authData");r&&e._objectEach(this.get("authData"),function(e,t){r[t]||delete r[t]})}},_synchronizeAllAuthData:function(){var r=this.get("authData");if(r){var t=this;e._objectEach(this.get("authData"),function(e,r){t._synchronizeAuthData(r)})}},_synchronizeAuthData:function(r){if(this.isCurrent()){var t;_.isString(r)?(t=r,r=e.User._authProviders[t]):t=r.getAuthType();var n=this.get("authData");if(n&&r){var s=r.restoreAuthentication(n[t]);s||this._unlinkFrom(r)}}},_handleSaveResult:function(r){return r&&(this._isCurrentUser=!0),this._cleanupAuthData(),this._synchronizeAllAuthData(),delete this._serverData.password,this._rebuildEstimatedDataForKey("password"),this._refreshCache(),r||this.isCurrent()?e.Promise.as(e.User._saveCurrentUser(this)):e.Promise.as()},_linkWith:function(r,t){var n;if(_.isString(r)?(n=r,r=e.User._authProviders[r]):n=r.getAuthType(),_.has(t,"authData")){var s=this.get("authData")||{};return s[n]=t.authData,this.set("authData",s),this.save({authData:s},filterOutCallbacks(t)).then(function(e){return e._handleSaveResult(!0).then(function(){return e})})._thenRunCallbacks(t)}var u=this,i=new e.Promise;return r.authenticate({success:function(e,r){u._linkWith(e,{authData:r,success:t.success,error:t.error}).then(function(){i.resolve(u)})},error:function(e,r){t.error&&t.error(u,r),i.reject(r)}}),i},_unlinkFrom:function(r,t){var n;_.isString(r)?(n=r,r=e.User._authProviders[r]):n=r.getAuthType();var s=_.clone(t),u=this;return s.authData=null,s.success=function(e){u._synchronizeAuthData(r),t.success&&t.success.apply(this,arguments)},this._linkWith(r,s)},_isLinked:function(e){var r;r=_.isString(e)?e:e.getAuthType();var t=this.get("authData")||{};return!!t[r]},_logOutWithAll:function(){var r=this.get("authData");if(r){var t=this;e._objectEach(this.get("authData"),function(e,r){t._logOutWith(r)})}},_logOutWith:function(r){this.isCurrent()&&(_.isString(r)&&(r=e.User._authProviders[r]),r&&r.deauthenticate&&r.deauthenticate())},signUp:function(r,t){var n;t=t||{};var s=r&&r.username||this.get("username");if(!s||""===s)throw n=new e.Error(e.Error.OTHER_CAUSE,"Cannot sign up user with an empty name."),t&&t.error&&t.error(this,n),n;var u=r&&r.password||this.get("password");if(!u||""===u)throw n=new e.Error(e.Error.OTHER_CAUSE,"Cannot sign up user with an empty password."),t&&t.error&&t.error(this,n),n;return this.save(r,filterOutCallbacks(t)).then(function(e){return e._handleSaveResult(!0).then(function(){return e})})._thenRunCallbacks(t,this)},signUpOrlogInWithMobilePhone:function(r,t){var n;t=t||{};var s=r&&r.mobilePhoneNumber||this.get("mobilePhoneNumber");if(!s||""===s)throw n=new e.Error(e.Error.OTHER_CAUSE,"Cannot sign up or login user by mobilePhoneNumber with an empty mobilePhoneNumber."),t&&t.error&&t.error(this,n),n;var u=r&&r.smsCode||this.get("smsCode");if(!u||""===u)throw n=new e.Error(e.Error.OTHER_CAUSE,"Cannot sign up or login user by mobilePhoneNumber  with an empty smsCode."),t&&t.error&&t.error(this,n),n;var i=filterOutCallbacks(t);return i._makeRequest=function(r,t,n,s,u){return e._request("usersByMobilePhone",null,null,"POST",u)},this.save(r,i).then(function(e){return delete e.attributes.smsCode,delete e._serverData.smsCode,e._handleSaveResult(!0).then(function(){return e})})._thenRunCallbacks(t)},logIn:function(r){var t=this,n=e._request("login",null,null,"GET",this.toJSON());return n.then(function(e,r,n){var s=t.parse(e,r,n);return t._finishFetch(s),t._handleSaveResult(!0).then(function(){return s.smsCode||delete t.attributes.smsCode,t})})._thenRunCallbacks(r,this)},save:function(r,t,n){var s,u;return _.isObject(r)||_.isNull(r)||_.isUndefined(r)?(s=r,u=t):(s={},s[r]=t,u=n),u=u||{},e.Object.prototype.save.call(this,s,filterOutCallbacks(u)).then(function(e){return e._handleSaveResult(!1).then(function(){return e})})._thenRunCallbacks(u)},follow:function(r,t){if(!this.id)throw"Please signin.";if(!r)throw"Invalid target user.";var n=_.isString(r)?r:r.id;if(!n)throw"Invalid target user.";var s="users/"+this.id+"/friendship/"+n,u=e._request(s,null,null,"POST",null);return u._thenRunCallbacks(t)},unfollow:function(r,t){if(!this.id)throw"Please signin.";if(!r)throw"Invalid target user.";var n=_.isString(r)?r:r.id;if(!n)throw"Invalid target user.";var s="users/"+this.id+"/friendship/"+n,u=e._request(s,null,null,"DELETE",null);return u._thenRunCallbacks(t)},followerQuery:function(){return e.User.followerQuery(this.id)},followeeQuery:function(){return e.User.followeeQuery(this.id)},fetch:function(){var r=null,t={};return 1===arguments.length?r=arguments[0]:2===arguments.length&&(t=arguments[0],r=arguments[1]),e.Object.prototype.fetch.call(this,t,{}).then(function(e){return e._handleSaveResult(!1).then(function(){return e})})._thenRunCallbacks(r)},updatePassword:function(r,t,n){var s="users/"+this.id+"/updatePassword",u={old_password:r,new_password:t},i=e._request(s,null,null,"PUT",u);return i._thenRunCallbacks(n,this)},isCurrent:function(){return this._isCurrentUser},getUsername:function(){return this.get("username")},getMobilePhoneNumber:function(){return this.get("mobilePhoneNumber")},setMobilePhoneNumber:function(e,r){return this.set("mobilePhoneNumber",e,r)},setUsername:function(e,r){return this.set("username",e,r)},setPassword:function(e,r){return this.set("password",e,r)},getEmail:function(){return this.get("email")},setEmail:function(e,r){return this.set("email",e,r)},authenticated:function(){return!!this._sessionToken&&e.User.current()&&e.User.current().id===this.id}},{_currentUser:null,_currentUserMatchesDisk:!1,_CURRENT_USER_KEY:"currentUser",_authProviders:{},signUp:function(r,t,n,s){n=n||{},n.username=r,n.password=t;var u=e.Object._create("_User");return u.signUp(n,s)},logIn:function(r,t,n){var s=e.Object._create("_User");return s._finishFetch({username:r,password:t}),s.logIn(n)},become:function(r,t){t=t||{};var n=e.Object._create("_User");return e._request("users","me",null,"GET",{useMasterKey:t.useMasterKey,session_token:r}).then(function(e,r,t){var s=n.parse(e,r,t);return n._finishFetch(s),n._handleSaveResult(!0).then(function(){return n})})._thenRunCallbacks(t,n)},logInWithMobilePhoneSmsCode:function(r,t,n){var s=e.Object._create("_User");return s._finishFetch({mobilePhoneNumber:r,smsCode:t}),s.logIn(n)},signUpOrlogInWithMobilePhone:function(r,t,n,s){n=n||{},n.mobilePhoneNumber=r,n.smsCode=t;var u=e.Object._create("_User");return u.signUpOrlogInWithMobilePhone(n,s)},logInWithMobilePhone:function(r,t,n){var s=e.Object._create("_User");return s._finishFetch({mobilePhoneNumber:r,password:t}),s.logIn(n)},signUpOrlogInWithAuthData:function(r,t,n){return e.User._logInWith(t,{authData:r,success:function(e){n.success(e)},error:function(e){n.error(e)}})},logOut:function(){return null!==e.User._currentUser&&(e.User._currentUser._logOutWithAll(),e.User._currentUser._isCurrentUser=!1),e.User._currentUserMatchesDisk=!0,e.User._currentUser=null,e.localStorage.removeItemAsync(e._getAVPath(e.User._CURRENT_USER_KEY))},followerQuery:function(r){if(!r||!_.isString(r))throw"Invalid user object id.";var t=new e.FriendShipQuery("_Follower");return t._friendshipTag="follower",t.equalTo("user",e.Object.createWithoutData("_User",r)),t},followeeQuery:function(r){if(!r||!_.isString(r))throw"Invalid user object id.";var t=new e.FriendShipQuery("_Followee");return t._friendshipTag="followee",t.equalTo("user",e.Object.createWithoutData("_User",r)),t},requestPasswordReset:function(r,t){var n={email:r},s=e._request("requestPasswordReset",null,null,"POST",n);return s._thenRunCallbacks(t)},requestEmailVerify:function(r,t){var n={email:r},s=e._request("requestEmailVerify",null,null,"POST",n);return s._thenRunCallbacks(t)},requestEmailVerfiy:function(r,t){var n={email:r},s=e._request("requestEmailVerify",null,null,"POST",n);return s._thenRunCallbacks(t)},requestMobilePhoneVerify:function(r,t){var n={mobilePhoneNumber:r},s=e._request("requestMobilePhoneVerify",null,null,"POST",n);return s._thenRunCallbacks(t)},requestPasswordResetBySmsCode:function(r,t){var n={mobilePhoneNumber:r},s=e._request("requestPasswordResetBySmsCode",null,null,"POST",n);return s._thenRunCallbacks(t)},resetPasswordBySmsCode:function(r,t,n){var s={password:t},u=e._request("resetPasswordBySmsCode",null,r,"PUT",s);return u._thenRunCallbacks(n)},verifyMobilePhone:function(r,t){var n=e._request("verifyMobilePhone",null,r,"POST",null);return n._thenRunCallbacks(t)},requestLoginSmsCode:function(r,t){var n={mobilePhoneNumber:r},s=e._request("requestLoginSmsCode",null,null,"POST",n);return s._thenRunCallbacks(t)},currentAsync:function(){return e.User._currentUser?e.Promise.as(e.User._currentUser):e.User._currentUserMatchesDisk?e.Promise.as(e.User._currentUser):e.localStorage.getItemAsync(e._getAVPath(e.User._CURRENT_USER_KEY)).then(function(r){if(!r)return null;e.User._currentUserMatchesDisk=!0,e.User._currentUser=e.Object._create("_User"),e.User._currentUser._isCurrentUser=!0;var t=JSON.parse(r);return e.User._currentUser.id=t._id,delete t._id,e.User._currentUser._sessionToken=t._sessionToken,delete t._sessionToken,e.User._currentUser._finishFetch(t),e.User._currentUser._synchronizeAllAuthData(),e.User._currentUser._refreshCache(),e.User._currentUser._opSetQueue=[{}],e.User._currentUser})},current:function(){if(e.User._currentUser)return e.User._currentUser;if(e.User._currentUserMatchesDisk)return e.User._currentUser;e.User._currentUserMatchesDisk=!0;var r=e.localStorage.getItem(e._getAVPath(e.User._CURRENT_USER_KEY));if(!r)return null;e.User._currentUser=e.Object._create("_User"),e.User._currentUser._isCurrentUser=!0;var t=JSON.parse(r);return e.User._currentUser.id=t._id,delete t._id,e.User._currentUser._sessionToken=t._sessionToken,delete t._sessionToken,e.User._currentUser._finishFetch(t),e.User._currentUser._synchronizeAllAuthData(),e.User._currentUser._refreshCache(),e.User._currentUser._opSetQueue=[{}],e.User._currentUser},_saveCurrentUser:function(r){var t;return t=e.User._currentUser!==r?e.User.logOut():e.Promise.as(),t.then(function(){r._isCurrentUser=!0,e.User._currentUser=r;var t=r.toJSON();return t._id=r.id,t._sessionToken=r._sessionToken,e.localStorage.setItemAsync(e._getAVPath(e.User._CURRENT_USER_KEY),JSON.stringify(t)).then(function(){e.User._currentUserMatchesDisk=!0})})},_registerAuthenticationProvider:function(r){e.User._authProviders[r.getAuthType()]=r,e.User.current()&&e.User.current()._synchronizeAuthData(r.getAuthType())},_logInWith:function(r,t){var n=e.Object._create("_User");return n._linkWith(r,t)}})};