"use strict";var _=require("underscore"),Promise=module.exports=function(e){this._resolved=!1,this._rejected=!1,this._resolvedCallbacks=[],this._rejectedCallbacks=[],this.doResolve(e)},_isNullOrUndefined=function(e){return _.isNull(e)||_.isUndefined(e)},_isNode=!1;"undefined"!=typeof process&&process.versions&&process.versions.node&&(_isNode=!0),_.extend(Promise,{_isPromisesAPlusCompliant:!_isNode,_debugError:!1,setPromisesAPlusCompliant:function(e){Promise._isPromisesAPlusCompliant=e},setDebugError:function(e){Promise._debugError=e},is:function(e){return e&&e.then&&_.isFunction(e.then)},as:function(){var e=new Promise;return arguments[0]&&_.isFunction(arguments[0].then)?arguments[0].then(function(r){e.resolve.call(e,r)},function(r){e.reject.call(e,r)}):e.resolve.apply(e,arguments),e},error:function(){var e=new Promise;return e.reject.apply(e,arguments),e},when:function(e){var r;r=e&&_isNullOrUndefined(e.length)?arguments:e;var t=_.last(arguments);t=_.isBoolean(t)?t:!1;var n=r.length,i=!1,s=[],o=[];if(s.length=r.length,o.length=r.length,0===n)return t?Promise.as.call(this,s):Promise.as.apply(this,s);var l=new Promise,c=function(e){return n-=1,i&&!l._rejected&&t?void l.reject.call(l,o[e]):void(0===n&&(i&&!l._rejected?l.reject.call(l,o):t?l._rejected||l.resolve.call(l,s):l.resolve.apply(l,s)))};return _.each(r,function(e,r){Promise.is(e)?e.then(function(e){s[r]=e,c(r)},function(e){o[r]=e,i=!0,c(r)}):(s[r]=e,c(r))}),l},race:function(e){var r;r=e&&_isNullOrUndefined(e.length)?arguments:e;var t=r.length,n=!1,i=[],s=[];if(i.length=s.length=r.length,0===t)return Promise.as.call(this);var o=new Promise,l=function(e){o._resolved||o._rejected||(n?o.reject.call(o,s[e]):o.resolve.call(o,i[e]))};return _.each(r,function(e,r){Promise.is(e)?e.then(function(e){i[r]=e,l(r)},function(e){s[r]=e,n=!0,l(r)}):(i[r]=e,l(r))}),o},_continueWhile:function(e,r){return e()?r().then(function(){return Promise._continueWhile(e,r)}):Promise.as()}}),Promise.all=function(e){return Promise.when(e,!0)},_.extend(Promise.prototype,{resolve:function(e){if(this._resolved||this._rejected)throw"A promise was resolved even though it had already been "+(this._resolved?"resolved":"rejected")+".";this._resolved=!0,this._result=arguments;var r=arguments;_.each(this._resolvedCallbacks,function(e){e.apply(this,r)}),this._resolvedCallbacks=[],this._rejectedCallbacks=[]},doResolve:function(e){if(e){var r=!1,t=this;try{e(function(e){r||(r=!0,t.resolve.call(t,e))},function(e){r||(r=!0,t.reject.call(t,e))})}catch(n){if(r)return;r=!0,t.reject.call(t,n)}}},reject:function(e){if(this._resolved||this._rejected)throw"A promise was rejected even though it had already been "+(this._resolved?"resolved":"rejected")+".";this._rejected=!0,this._error=e,_.each(this._rejectedCallbacks,function(r){r(e)}),this._resolvedCallbacks=[],this._rejectedCallbacks=[]},then:function(e,r){var t=new Promise,n=function(){var r=arguments;if(e)if(Promise._isPromisesAPlusCompliant)try{r=[e.apply(this,r)]}catch(n){Promise._debugError&&n&&console.error("Error occurred in promise resolve callback.",n.stack||n),r=[Promise.error(n)]}else r=[e.apply(this,r)];1===r.length&&Promise.is(r[0])?r[0].then(function(){t.resolve.apply(t,arguments)},function(e){t.reject(e)}):t.resolve.apply(t,r)},i=function(e){var n=[];if(r){if(Promise._isPromisesAPlusCompliant)try{n=[r(e)]}catch(i){Promise._debugError&&i&&console.error("Error occurred in promise reject callback.",i.stack||i),n=[Promise.error(i)]}else n=[r(e)];1===n.length&&Promise.is(n[0])?n[0].then(function(){t.resolve.apply(t,arguments)},function(e){t.reject(e)}):Promise._isPromisesAPlusCompliant?t.resolve.apply(t,n):t.reject(n[0])}else t.reject(e)},s=function(e){e.call()};Promise._isPromisesAPlusCompliant&&("undefined"!=typeof window&&_.isFunction(window.setImmediate)?s=function(e){window.setImmediate(e)}:"undefined"!=typeof process&&process.nextTick?s=function(e){process.nextTick(e)}:"undefined"!=typeof setTimeout&&_.isFunction(setTimeout)&&(s=function(e){setTimeout(e,0)}));var o=this;return this._resolved?s(function(){n.apply(o,o._result)}):this._rejected?s(function(){i.apply(o,[o._error])}):(this._resolvedCallbacks.push(n),this._rejectedCallbacks.push(i)),t},"catch":function(e){return this.then(void 0,e)},always:function(e){return this.then(e,e)},done:function(e){return this.then(e)},fail:function(e){return this.then(null,e)},_thenRunCallbacks:function(e,r){var t;if(_.isFunction(e)){var n=e;t={success:function(e){n(e,null)},error:function(e){n(null,e)}}}else t=_.clone(e);return t=t||{},this.then(function(e){return t.success?t.success.apply(this,arguments):r&&r.trigger("sync",r,e,t),Promise.as.apply(Promise,arguments)},function(e){return t.error?_.isUndefined(r)?t.error(e):t.error(r,e):r&&r.trigger("error",r,e,t),Promise.error(e)})},_continueWith:function(e){return this.then(function(){return e(arguments,null)},function(r){return e(null,r)})}}),Promise.prototype["finally"]=Promise.prototype.always,Promise.prototype["try"]=Promise.prototype.done;