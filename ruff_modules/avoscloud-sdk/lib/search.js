"use strict";var _=require("underscore");module.exports=function(t){t.SearchSortBuilder=function(){this._sortFields=[]},t.SearchSortBuilder.prototype={_addField:function(t,i,s,e){var r={};return r[t]={order:i||"asc",mode:s||"avg",missing:"_"+(e||"last")},this._sortFields.push(r),this},ascending:function(t,i,s){return this._addField(t,"asc",i,s)},descending:function(t,i,s){return this._addField(t,"desc",i,s)},whereNear:function(t,i,s){s=s||{};var e={},r={lat:i.latitude,lon:i.longitude},n={order:s.order||"asc",mode:s.mode||"avg",unit:s.unit||"km"};return n[t]=r,e._geo_distance=n,this._sortFields.push(e),this},build:function(){return JSON.stringify(t._encode(this._sortFields))}},t.SearchQuery=t.Query._extend({_sid:null,_hits:0,_queryString:null,_highlights:null,_sortBuilder:null,_createRequest:function(i){return t._request("search/select",null,null,"GET",i||this.toJSON())},sid:function(t){return this._sid=t,this},queryString:function(t){return this._queryString=t,this},highlights:function(t){var i;return i=t&&_.isString(t)?arguments:t,this._highlights=i,this},sortBy:function(t){return this._sortBuilder=t,this},hits:function(){return this._hits||(this._hits=0),this._hits},_processResult:function(t){return delete t.className,delete t._app_url,delete t._deeplink,t},hasMore:function(){return!this._hitEnd},reset:function(){this._hitEnd=!1,this._sid=null,this._hits=0},find:function(t){var i=this,s=this._createRequest();return s.then(function(t){return t.sid?(i._oldSid=i._sid,i._sid=t.sid):(i._sid=null,i._hitEnd=!0),i._hits=t.hits||0,_.map(t.results,function(s){s.className&&(t.className=s.className);var e=i._newObject(t);return e.appURL=s._app_url,e._finishFetch(i._processResult(s),!0),e})})._thenRunCallbacks(t)},toJSON:function(){var i=t.SearchQuery.__super__.toJSON.call(this);if(delete i.where,this.className&&(i.clazz=this.className),this._sid&&(i.sid=this._sid),!this._queryString)throw"Please set query string.";if(i.q=this._queryString,this._highlights&&(i.highlights=this._highlights.join(",")),this._sortBuilder&&i.order)throw"sort and order can not be set at same time.";return this._sortBuilder&&(i.sort=this._sortBuilder.build()),i}})};