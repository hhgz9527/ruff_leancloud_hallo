"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},_=require("underscore");module.exports=function(e){_.extend(e._config,{cnApiUrl:"https://api.leancloud.cn",usApiUrl:"https://us-api.leancloud.cn"}),"undefined"!=typeof process&&process.versions&&process.versions.node&&(e._config.isNode=!0);var t=function(){},n=function(e,n,i){var r;return r=n&&n.hasOwnProperty("constructor")?n.constructor:function(){e.apply(this,arguments)},_.extend(r,e),t.prototype=e.prototype,r.prototype=new t,n&&_.extend(r.prototype,n),i&&_.extend(r,i),r.prototype.constructor=r,r.__super__=e.prototype,r},i=function(t,n,i){void 0!==e.applicationId&&t!==e.applicationId&&n!==e.applicationKey&&i!==e.masterKey&&console.warn("AVOSCloud SDK is already initialized, please don't reinitialize it."),e.applicationId=t,e.applicationKey=n,e.masterKey=i,e._useMasterKey=!1};e.init=function(){switch(arguments.length){case 1:var t=arguments.length<=0?void 0:arguments[0];if("object"!==("undefined"==typeof t?"undefined":_typeof(t)))throw new Error("AV.init(): Parameter is not correct.");if(!e._config.isNode&&t.masterKey)throw new Error("AV.init(): Master Key is only used in Node.js.");i(t.appId,t.appKey,t.masterKey);break;case 2:case 3:if(!e._config.isNode&&3===arguments.length)throw new Error("AV.init(): Master Key is only used in Node.js.");i.apply(void 0,arguments)}},e._config.isNode&&(e.Cloud=e.Cloud||{},e.Cloud.useMasterKey=function(){e._useMasterKey=!0}),e.initialize=e.init,e.setProduction=function(t){e._isNullOrUndefined(t)||(t=t?1:0),e.applicationProduction=e._isNullOrUndefined(t)?1:t},e.useAVCloudCN=function(){e.serverURL=e._config.cnApiUrl},e.useAVCloudUS=function(){e.serverURL=e._config.usApiUrl},e.useAVCloudCN(),e._getAVPath=function(t){if(!e.applicationId)throw"You need to call AV.initialize before using AV.";if(t||(t=""),!e._.isString(t))throw"Tried to get a localStorage path that wasn't a String.";return"/"===t[0]&&(t=t.substring(1)),"AV/"+e.applicationId+"/"+t},e._installationId=null,e._getInstallationId=function(){if(e._installationId)return e.Promise.as(e._installationId);var t=e._getAVPath("installationId");return e.localStorage.getItemAsync(t).then(function(n){if(e._installationId=n,e._installationId)return n;var i=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return e._installationId=i()+i()+"-"+i()+"-"+i()+"-"+i()+"-"+i()+i()+i(),e.localStorage.setItemAsync(t,e._installationId)})},e._parseDate=function(e){var t=new RegExp("^([0-9]{1,4})-([0-9]{1,2})-([0-9]{1,2})T([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2})(.([0-9]+))?Z$"),n=t.exec(e);if(!n)return null;var i=n[1]||0,r=(n[2]||1)-1,o=n[3]||0,a=n[4]||0,s=n[5]||0,c=n[6]||0,u=n[8]||0;return new Date(Date.UTC(i,r,o,a,s,c,u))},e._ajax=require("./browserify-wrapper/ajax"),e._extend=function(e,t){var i=n(this,e,t);return i.extend=this.extend,i},e._request=function(t,n,i,r,o){if(!e.applicationId)throw"You must specify your applicationId using AV.initialize";if(!e.applicationKey&&!e.masterKey)throw"You must specify a key using AV.initialize";if("batch"!==t&&"classes"!==t&&"files"!==t&&"date"!==t&&"functions"!==t&&"call"!==t&&"login"!==t&&"push"!==t&&"search/select"!==t&&"requestPasswordReset"!==t&&"requestEmailVerify"!==t&&"requestPasswordResetBySmsCode"!==t&&"resetPasswordBySmsCode"!==t&&"requestMobilePhoneVerify"!==t&&"requestLoginSmsCode"!==t&&"verifyMobilePhone"!==t&&"requestSmsCode"!==t&&"verifySmsCode"!==t&&"users"!==t&&"usersByMobilePhone"!==t&&"cloudQuery"!==t&&"qiniu"!==t&&"statuses"!==t&&"bigquery"!==t&&"search/select"!==t&&"subscribe/statuses/count"!==t&&"subscribe/statuses"!==t&&"installations"!==t&&!/users\/[^\/]+\/updatePassword/.test(t)&&!/users\/[^\/]+\/friendship\/[^\/]+/.test(t))throw"Bad route: '"+t+"'.";var a=e.serverURL;return"/"!==a.charAt(a.length-1)&&(a+="/"),a+="1.1/"+t,n&&(a+="/"+n),i&&(a+="/"+i),("users"===t||"classes"===t)&&o&&o._fetchWhenSave&&(delete o._fetchWhenSave,a+="?new=true"),o=e._.clone(o||{}),"POST"!==r&&(o._method=r,r="POST"),o._ApplicationId=e.applicationId,o._ApplicationKey=e.applicationKey,e._isNullOrUndefined(e.applicationProduction)||(o._ApplicationProduction=e.applicationProduction),e._useMasterKey&&(o._MasterKey=e.masterKey),o._ClientVersion=e.VERSION,e.User.currentAsync().then(function(t){return t&&t._sessionToken&&(o._SessionToken=t._sessionToken),e._getInstallationId()}).then(function(t){o._InstallationId=t;var n=JSON.stringify(o);return e._ajax(r,a,n).then(null,function(t){var n;if(t&&t.responseText)try{var i=JSON.parse(t.responseText);i&&(n=new e.Error(i.code,i.error))}catch(r){}return n=n||new e.Error(-1,t.responseText),e.Promise.error(n)})})},e._getValue=function(t,n){return t&&t[n]?e._.isFunction(t[n])?t[n]():t[n]:null},e._encode=function(t,n,i){var r=e._;if(t instanceof e.Object){if(i)throw"AV.Objects not allowed here";if(!n||r.include(n,t)||!t._hasData)return t._toPointer();if(!t.dirty())return n=n.concat(t),e._encode(t._toFullJSON(n),n,i);throw"Tried to save an object with a pointer to a new, unsaved object."}if(t instanceof e.ACL)return t.toJSON();if(r.isDate(t))return{__type:"Date",iso:t.toJSON()};if(t instanceof e.GeoPoint)return t.toJSON();if(r.isArray(t))return r.map(t,function(t){return e._encode(t,n,i)});if(r.isRegExp(t))return t.source;if(t instanceof e.Relation)return t.toJSON();if(t instanceof e.Op)return t.toJSON();if(t instanceof e.File){if(!t.url()&&!t.id)throw"Tried to save an object containing an unsaved file.";return{__type:"File",id:t.id,name:t.name(),url:t.url()}}if(r.isObject(t)){var o={};return e._objectEach(t,function(t,r){o[r]=e._encode(t,n,i)}),o}return t},e._decode=function(t,n){var i=e._;if(!i.isObject(n))return n;if(i.isArray(n))return e._arrayEach(n,function(t,i){n[i]=e._decode(i,t)}),n;if(n instanceof e.Object)return n;if(n instanceof e.File)return n;if(n instanceof e.Op)return n;if(n.__op)return e.Op._decode(n);var r;if("Pointer"===n.__type){r=n.className;var o=e.Object._create(r);return Object.keys(n).length>3?(delete n.__type,delete n.className,o._finishFetch(n,!0)):o._finishFetch({objectId:n.objectId},!1),o}if("Object"===n.__type){r=n.className,delete n.__type,delete n.className;var a=e.Object._create(r);return a._finishFetch(n,!0),a}if("Date"===n.__type)return e._parseDate(n.iso);if("GeoPoint"===n.__type)return new e.GeoPoint({latitude:n.latitude,longitude:n.longitude});if("ACL"===t)return n instanceof e.ACL?n:new e.ACL(n);if("Relation"===n.__type){var s=new e.Relation(null,t);return s.targetClassName=n.className,s}if("File"===n.__type){var c=new e.File(n.name);return c._metaData=n.metaData||{},c._url=n.url,c.id=n.objectId,c}return e._objectEach(n,function(t,i){n[i]=e._decode(i,t)}),n},e._encodeObjectOrArray=function(t){var n=function(t){return t&&t._toFullJSON&&(t=t._toFullJSON([])),_.mapObject(t,function(t){return e._encode(t,[])})};return _.isArray(t)?t.map(function(e){return n(e)}):n(t)},e._arrayEach=e._.each,e._traverse=function(t,n,i){if(t instanceof e.Object){if(i=i||[],e._.indexOf(i,t)>=0)return;return i.push(t),e._traverse(t.attributes,n,i),n(t)}return t instanceof e.Relation||t instanceof e.File?n(t):e._.isArray(t)?(e._.each(t,function(r,o){var a=e._traverse(r,n,i);a&&(t[o]=a)}),n(t)):e._.isObject(t)?(e._each(t,function(r,o){var a=e._traverse(r,n,i);a&&(t[o]=a)}),n(t)):n(t)},e._objectEach=e._each=function(t,n){var i=e._;i.isObject(t)?i.each(i.keys(t),function(e){n(t[e],e)}):i.each(t,n)},e._isNullOrUndefined=function(t){return e._.isNull(t)||e._.isUndefined(t)}};