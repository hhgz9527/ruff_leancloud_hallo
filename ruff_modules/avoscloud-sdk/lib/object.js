"use strict";var _=require("underscore");module.exports=function(t){t.Object=function(e,i){if(_.isString(e))return t.Object._create.apply(this,arguments);e=e||{},i&&i.parse&&(e=this.parse(e));var n=t._getValue(this,"defaults");if(n&&(e=_.extend({},n,e)),i&&i.collection&&(this.collection=i.collection),this._serverData={},this._opSetQueue=[{}],this.attributes={},this._hashedJSON={},this._escapedAttributes={},this.cid=_.uniqueId("c"),this.changed={},this._silent={},this._pending={},!this.set(e,{silent:!0}))throw new Error("Can't create an invalid AV.Object");this.changed={},this._silent={},this._pending={},this._hasData=!0,this._previousAttributes=_.clone(this.attributes),this.initialize.apply(this,arguments)},t.Object.saveAll=function(e,i){return t.Object._deepSaveAsync(e)._thenRunCallbacks(i)},_.extend(t.Object.prototype,t.Events,{_fetchWhenSave:!1,initialize:function(){},fetchWhenSave:function(t){if(!_.isBoolean(t))throw"Expect boolean value for fetchWhenSave";this._fetchWhenSave=t},getObjectId:function(){return this.id},getCreatedAt:function(){return this.createdAt||this.get("createdAt")},getUpdatedAt:function(){return this.updatedAt||this.get("updatedAt")},toJSON:function(){var e=this._toFullJSON();return t._arrayEach(["__type","className"],function(t){delete e[t]}),e},_toFullJSON:function(e){var i=_.clone(this.attributes);return t._objectEach(i,function(n,r){i[r]=t._encode(n,e)}),t._objectEach(this._operations,function(t,e){i[e]=t}),_.has(this,"id")&&(i.objectId=this.id),_.has(this,"createdAt")&&(_.isDate(this.createdAt)?i.createdAt=this.createdAt.toJSON():i.createdAt=this.createdAt),_.has(this,"updatedAt")&&(_.isDate(this.updatedAt)?i.updatedAt=this.updatedAt.toJSON():i.updatedAt=this.updatedAt),i.__type="Object",i.className=this.className,i},_refreshCache:function(){var e=this;e._refreshingCache||(e._refreshingCache=!0,t._objectEach(this.attributes,function(i,n){i instanceof t.Object?i._refreshCache():_.isObject(i)&&e._resetCacheForKey(n)&&e.set(n,new t.Op.Set(i),{silent:!0})}),delete e._refreshingCache)},dirty:function(t){this._refreshCache();var e=_.last(this._opSetQueue);return t?!!e[t]:this.id?_.keys(e).length>0:!0},_toPointer:function(){return{__type:"Pointer",className:this.className,objectId:this.id}},get:function(t){return this.attributes[t]},relation:function(e){var i=this.get(e);if(i){if(!(i instanceof t.Relation))throw"Called relation() on non-relation field "+e;return i._ensureParentAndKey(this,e),i}return new t.Relation(this,e)},escape:function(e){var i=this._escapedAttributes[e];if(i)return i;var n,r=this.attributes[e];return n=t._isNullOrUndefined(r)?"":_.escape(r.toString()),this._escapedAttributes[e]=n,n},has:function(e){return!t._isNullOrUndefined(this.attributes[e])},_mergeMagicFields:function(e){var i=this,n=["id","objectId","createdAt","updatedAt"];t._arrayEach(n,function(n){e[n]&&("objectId"===n?i.id=e[n]:"createdAt"!==n&&"updatedAt"!==n||_.isDate(e[n])?i[n]=e[n]:i[n]=t._parseDate(e[n]),delete e[n])})},_startSave:function(){this._opSetQueue.push({})},_cancelSave:function(){var e=_.first(this._opSetQueue);this._opSetQueue=_.rest(this._opSetQueue);var i=_.first(this._opSetQueue);t._objectEach(e,function(t,n){var r=e[n],s=i[n];r&&s?i[n]=s._mergeWithPrevious(r):r&&(i[n]=r)}),this._saving=this._saving-1},_finishSave:function(e){var i={};t._traverse(this.attributes,function(e){e instanceof t.Object&&e.id&&e._hasData&&(i[e.id]=e)});var n=_.first(this._opSetQueue);this._opSetQueue=_.rest(this._opSetQueue),this._applyOpSet(n,this._serverData),this._mergeMagicFields(e);var r=this;t._objectEach(e,function(e,n){r._serverData[n]=t._decode(n,e);var s=t._traverse(r._serverData[n],function(e){return e instanceof t.Object&&i[e.id]?i[e.id]:void 0});s&&(r._serverData[n]=s)}),this._rebuildAllEstimatedData(),this._saving=this._saving-1},_finishFetch:function(e,i){this._opSetQueue=[{}],this._mergeMagicFields(e);var n=this;t._objectEach(e,function(e,i){n._serverData[i]=t._decode(i,e)}),this._rebuildAllEstimatedData(),this._refreshCache(),this._opSetQueue=[{}],this._hasData=i},_applyOpSet:function(e,i){var n=this;t._objectEach(e,function(e,r){i[r]=e._estimate(i[r],n,r),i[r]===t.Op._UNSET&&delete i[r]})},_resetCacheForKey:function(e){var i=this.attributes[e];if(_.isObject(i)&&!(i instanceof t.Object)&&!(i instanceof t.File)){i=i.toJSON?i.toJSON():i;var n=JSON.stringify(i);if(this._hashedJSON[e]!==n){var r=!!this._hashedJSON[e];return this._hashedJSON[e]=n,r}}return!1},_rebuildEstimatedDataForKey:function(e){var i=this;delete this.attributes[e],this._serverData[e]&&(this.attributes[e]=this._serverData[e]),t._arrayEach(this._opSetQueue,function(n){var r=n[e];r&&(i.attributes[e]=r._estimate(i.attributes[e],i,e),i.attributes[e]===t.Op._UNSET?delete i.attributes[e]:i._resetCacheForKey(e))})},_rebuildAllEstimatedData:function(){var e=this,i=_.clone(this.attributes);this.attributes=_.clone(this._serverData),t._arrayEach(this._opSetQueue,function(i){e._applyOpSet(i,e.attributes),t._objectEach(i,function(t,i){e._resetCacheForKey(i)})}),t._objectEach(i,function(t,i){e.attributes[i]!==t&&e.trigger("change:"+i,e,e.attributes[i],{})}),t._objectEach(this.attributes,function(t,n){_.has(i,n)||e.trigger("change:"+n,e,t,{})})},set:function(e,i,n){var r;if(_.isObject(e)||t._isNullOrUndefined(e)?(r=e,t._objectEach(r,function(e,i){r[i]=t._decode(i,e)}),n=i):(r={},r[e]=t._decode(e,i)),n=n||{},!r)return this;r instanceof t.Object&&(r=r.attributes),n.unset&&t._objectEach(r,function(e,i){r[i]=new t.Op.Unset});var s=_.clone(r),a=this;if(t._objectEach(s,function(e,i){e instanceof t.Op&&(s[i]=e._estimate(a.attributes[i],a,i),s[i]===t.Op._UNSET&&delete s[i])}),!this._validate(r,n))return!1;this._mergeMagicFields(r),n.changes={};var c=this._escapedAttributes;this._previousAttributes||{};return t._arrayEach(_.keys(r),function(e){var i=r[e];i instanceof t.Relation&&(i.parent=a),i instanceof t.Op||(i=new t.Op.Set(i));var s=!0;i instanceof t.Op.Set&&_.isEqual(a.attributes[e],i.value)&&(s=!1),s&&(delete c[e],n.silent?a._silent[e]=!0:n.changes[e]=!0);var u=_.last(a._opSetQueue);u[e]=i._mergeWithPrevious(u[e]),a._rebuildEstimatedDataForKey(e),s?(a.changed[e]=a.attributes[e],n.silent||(a._pending[e]=!0)):(delete a.changed[e],delete a._pending[e])}),n.silent||this.change(n),this},unset:function(t,e){return e=e||{},e.unset=!0,this.set(t,null,e)},increment:function(e,i){return(_.isUndefined(i)||_.isNull(i))&&(i=1),this.set(e,new t.Op.Increment(i))},add:function(e,i){return this.set(e,new t.Op.Add([i]))},addUnique:function(e,i){return this.set(e,new t.Op.AddUnique([i]))},remove:function(e,i){return this.set(e,new t.Op.Remove([i]))},op:function(t){return _.last(this._opSetQueue)[t]},clear:function(t){t=t||{},t.unset=!0;var e=_.extend(this.attributes,this._operations);return this.set(e,t)},_getSaveJSON:function(){var e=_.clone(_.first(this._opSetQueue));return t._objectEach(e,function(t,i){e[i]=t.toJSON()}),e},_canBeSerialized:function(){return t.Object._canBeSerializedAsValue(this.attributes)},fetch:function(){var e=null,i={};1===arguments.length?e=arguments[0]:2===arguments.length&&(i=arguments[0],e=arguments[1]);var n=this,r=t._request("classes",this.className,this.id,"GET",i);return r.then(function(t){return n._finishFetch(n.parse(t),!0),n})._thenRunCallbacks(e,this)},save:function(e,i,n){var r,s,a;if(_.isObject(e)||t._isNullOrUndefined(e)?(r=e,a=i):(r={},r[e]=i,a=n),!a&&r){var c=_.reject(r,function(t,e){return _.include(["success","error","wait"],e)});if(0===c.length){var u=!0;if(_.has(r,"success")&&!_.isFunction(r.success)&&(u=!1),_.has(r,"error")&&!_.isFunction(r.error)&&(u=!1),u)return this.save(null,r)}}a=_.clone(a)||{},a.wait&&(s=_.clone(this.attributes));var h=_.clone(a)||{};h.wait&&(h.silent=!0);var o;if(h.error=function(t,e){o=e},r&&!this.set(r,h))return t.Promise.error(o)._thenRunCallbacks(a,this);var l=this;l._refreshCache();var d=[],f=[];return t.Object._findUnsavedChildren(l.attributes,d,f),d.length+f.length>0?t.Object._deepSaveAsync(this.attributes,l).then(function(){return l.save(null,a)},function(e){return t.Promise.error(e)._thenRunCallbacks(a,l)}):(this._startSave(),this._saving=(this._saving||0)+1,this._allPreviousSaves=this._allPreviousSaves||t.Promise.as(),this._allPreviousSaves=this._allPreviousSaves._continueWith(function(){var e=l.id?"PUT":"POST",i=l._getSaveJSON();l._fetchWhenSave&&(i._fetchWhenSave=!0);var n="classes",c=l.className;"_User"!==l.className||l.id||(n="users",c=null);var u=a._makeRequest||t._request,o=u(n,c,l.id,e,i);return o=o.then(function(t){var e=l.parse(t);return a.wait&&(e=_.extend(r||{},e)),l._finishSave(e),a.wait&&l.set(s,h),l},function(e){return l._cancelSave(),t.Promise.error(e)})._thenRunCallbacks(a,l)}),this._allPreviousSaves)},destroy:function(e){e=e||{};var i=this,n=function(){i.trigger("destroy",i,i.collection,e)};if(!this.id)return n();e.wait||n();var r=t._request("classes",this.className,this.id,"DELETE");return r.then(function(){return e.wait&&n(),i})._thenRunCallbacks(e,this)},parse:function(e){var i=_.clone(e);return _(["createdAt","updatedAt"]).each(function(e){i[e]&&(i[e]=t._parseDate(i[e]))}),i.updatedAt||(i.updatedAt=i.createdAt),i},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.id},change:function(e){e=e||{};var i=this._changing;this._changing=!0;var n=this;t._objectEach(this._silent,function(t){n._pending[t]=!0});var r=_.extend({},e.changes,this._silent);if(this._silent={},t._objectEach(r,function(t,i){n.trigger("change:"+i,n,n.get(i),e)}),i)return this;for(var s=function(t,e){n._pending[e]||n._silent[e]||delete n.changed[e]};!_.isEmpty(this._pending);)this._pending={},this.trigger("change",this,e),t._objectEach(this.changed,s),n._previousAttributes=_.clone(this.attributes);return this._changing=!1,this},existed:function(){return console.warn("AV.Object.prototype.existed() is deprecated."),!1},hasChanged:function(t){return arguments.length?this.changed&&_.has(this.changed,t):!_.isEmpty(this.changed)},changedAttributes:function(e){if(!e)return this.hasChanged()?_.clone(this.changed):!1;var i={},n=this._previousAttributes;return t._objectEach(e,function(t,e){_.isEqual(n[e],t)||(i[e]=t)}),i},previous:function(t){return arguments.length&&this._previousAttributes?this._previousAttributes[t]:null},previousAttributes:function(){return _.clone(this._previousAttributes)},isValid:function(){return!this.validate(this.attributes)},validate:function(e,i){return!_.has(e,"ACL")||e.ACL instanceof t.ACL?!1:new t.Error(t.Error.OTHER_CAUSE,"ACL must be a AV.ACL.")},_validate:function(t,e){if(e.silent||!this.validate)return!0;t=_.extend({},this.attributes,t);var i=this.validate(t,e);return i?(e&&e.error?e.error(this,i,e):this.trigger("error",this,i,e),!1):!0},getACL:function(){return this.get("ACL")},setACL:function(t,e){return this.set("ACL",t,e)}}),t.Object.createWithoutData=function(e,i,n){var r=new t.Object(e);return r.id=i,r._hasData=n,r},t.Object.destroyAll=function(e,i){if(null==e||0==e.length)return t.Promise.as()._thenRunCallbacks(i);var n=e[0].className,r="",s=!0;e.forEach(function(t){if(t.className!=n)throw"AV.Object.destroyAll requires the argument object array's classNames must be the same";if(!t.id)throw"Could not delete unsaved object";s?(r=t.id,s=!1):r=r+","+t.id});var a=t._request("classes",n,r,"DELETE");return a._thenRunCallbacks(i)},t.Object._getSubclass=function(e){if(!_.isString(e))throw"AV.Object._getSubclass requires a string argument.";var i=t.Object._classMap[e];return i||(i=t.Object.extend(e),t.Object._classMap[e]=i),i},t.Object._create=function(e,i,n){var r=t.Object._getSubclass(e);return new r(i,n)},t.Object._classMap={},t.Object._extend=t._extend,t.Object["new"]=function(e,i){return new t.Object(e,i)},t.Object.extend=function(e,i,n){if(!_.isString(e)){if(e&&_.has(e,"className"))return t.Object.extend(e.className,e,i);throw new Error("AV.Object.extend's first argument should be the className.")}"User"===e&&(e="_User");var r=null;if(_.has(t.Object._classMap,e)){var s=t.Object._classMap[e];r=s._extend(i,n)}else i=i||{},i.className=e,r=this._extend(i,n);return r.extend=function(i){if(_.isString(i)||i&&_.has(i,"className"))return t.Object.extend.apply(r,arguments);var n=[e].concat(t._.toArray(arguments));return t.Object.extend.apply(r,n)},r["new"]=function(t,e){return new r(t,e)},t.Object._classMap[e]=r,r},t.Object._findUnsavedChildren=function(e,i,n){t._traverse(e,function(e){return e instanceof t.Object?(e._refreshCache(),void(e.dirty()&&i.push(e))):e instanceof t.File?void(e.url()||e.id||n.push(e)):void 0})},t.Object._canBeSerializedAsValue=function(e){var i=!0;return e instanceof t.Object||e instanceof t.File?i=!!e.id:_.isArray(e)?t._arrayEach(e,function(e){t.Object._canBeSerializedAsValue(e)||(i=!1)}):_.isObject(e)&&t._objectEach(e,function(e){t.Object._canBeSerializedAsValue(e)||(i=!1)}),i},t.Object._deepSaveAsync=function(e,i){var n=[],r=[];t.Object._findUnsavedChildren(e,n,r),i&&(n=_.filter(n,function(t){return t!=i}));var s=t.Promise.as();_.each(r,function(t){s=s.then(function(){return t.save()})});var a=_.uniq(n),c=_.uniq(a);return s.then(function(){return t.Promise._continueWhile(function(){return c.length>0},function(){var e=[],i=[];if(t._arrayEach(c,function(t){return e.length>20?void i.push(t):void(t._canBeSerialized()?e.push(t):i.push(t))}),c=i,0===e.length)return t.Promise.error(new t.Error(t.Error.OTHER_CAUSE,"Tried to save a batch with a cycle."));var n=t.Promise.when(_.map(e,function(e){return e._allPreviousSaves||t.Promise.as()})),r=new t.Promise;return t._arrayEach(e,function(t){t._allPreviousSaves=r}),n._continueWith(function(){return t._request("batch",null,null,"POST",{requests:_.map(e,function(t){var e=t._getSaveJSON(),i="POST",n="/1.1/classes/"+t.className;return t.id&&(n=n+"/"+t.id,i="PUT"),t._startSave(),{method:i,path:n,body:e}})}).then(function(i){var n;return t._arrayEach(e,function(t,e){i[e].success?t._finishSave(t.parse(i[e].success)):(n=n||i[e].error,t._cancelSave())}),n?t.Promise.error(new t.Error(n.code,n.error)):void 0}).then(function(t){return r.resolve(t),t},function(e){return r.reject(e),t.Promise.error(e)})})})}).then(function(){return e})}};