"use strict";function extname(a){return a.match(/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/)[4]}var _=require("underscore");module.exports=function(a){var e=function(a){if(26>a)return String.fromCharCode(65+a);if(52>a)return String.fromCharCode(97+(a-26));if(62>a)return String.fromCharCode(48+(a-52));if(62===a)return"+";if(63===a)return"/";throw"Tried to encode large digit "+a+" in base64."},i=function(a){var i=[];return i.length=Math.ceil(a.length/3),_.times(i.length,function(t){var n=a[3*t],o=a[3*t+1]||0,p=a[3*t+2]||0,r=3*t+1<a.length,l=3*t+2<a.length;i[t]=[e(n>>2&63),e(n<<4&48|o>>4&15),r?e(o<<2&60|p>>6&3):"=",l?e(63&p):"="].join("")}),i.join("")},t=function(a){return a.split(",")[0]&&a.split(",")[0].indexOf("base64")>=0&&(a=a.split(",")[1]),a},n=function(){var e=a.serverURL.match(/\/\/(.*)/,"g")[1],i=a._config.cnApiUrl.match(/\/\/(.*)/,"g")[1];return e===i},o={ai:"application/postscript",aif:"audio/x-aiff",aifc:"audio/x-aiff",aiff:"audio/x-aiff",asc:"text/plain",atom:"application/atom+xml",au:"audio/basic",avi:"video/x-msvideo",bcpio:"application/x-bcpio",bin:"application/octet-stream",bmp:"image/bmp",cdf:"application/x-netcdf",cgm:"image/cgm","class":"application/octet-stream",cpio:"application/x-cpio",cpt:"application/mac-compactpro",csh:"application/x-csh",css:"text/css",dcr:"application/x-director",dif:"video/x-dv",dir:"application/x-director",djv:"image/vnd.djvu",djvu:"image/vnd.djvu",dll:"application/octet-stream",dmg:"application/octet-stream",dms:"application/octet-stream",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",dotx:"application/vnd.openxmlformats-officedocument.wordprocessingml.template",docm:"application/vnd.ms-word.document.macroEnabled.12",dotm:"application/vnd.ms-word.template.macroEnabled.12",dtd:"application/xml-dtd",dv:"video/x-dv",dvi:"application/x-dvi",dxr:"application/x-director",eps:"application/postscript",etx:"text/x-setext",exe:"application/octet-stream",ez:"application/andrew-inset",gif:"image/gif",gram:"application/srgs",grxml:"application/srgs+xml",gtar:"application/x-gtar",hdf:"application/x-hdf",hqx:"application/mac-binhex40",htm:"text/html",html:"text/html",ice:"x-conference/x-cooltalk",ico:"image/x-icon",ics:"text/calendar",ief:"image/ief",ifb:"text/calendar",iges:"model/iges",igs:"model/iges",jnlp:"application/x-java-jnlp-file",jp2:"image/jp2",jpe:"image/jpeg",jpeg:"image/jpeg",jpg:"image/jpeg",js:"application/x-javascript",kar:"audio/midi",latex:"application/x-latex",lha:"application/octet-stream",lzh:"application/octet-stream",m3u:"audio/x-mpegurl",m4a:"audio/mp4a-latm",m4b:"audio/mp4a-latm",m4p:"audio/mp4a-latm",m4u:"video/vnd.mpegurl",m4v:"video/x-m4v",mac:"image/x-macpaint",man:"application/x-troff-man",mathml:"application/mathml+xml",me:"application/x-troff-me",mesh:"model/mesh",mid:"audio/midi",midi:"audio/midi",mif:"application/vnd.mif",mov:"video/quicktime",movie:"video/x-sgi-movie",mp2:"audio/mpeg",mp3:"audio/mpeg",mp4:"video/mp4",mpe:"video/mpeg",mpeg:"video/mpeg",mpg:"video/mpeg",mpga:"audio/mpeg",ms:"application/x-troff-ms",msh:"model/mesh",mxu:"video/vnd.mpegurl",nc:"application/x-netcdf",oda:"application/oda",ogg:"application/ogg",pbm:"image/x-portable-bitmap",pct:"image/pict",pdb:"chemical/x-pdb",pdf:"application/pdf",pgm:"image/x-portable-graymap",pgn:"application/x-chess-pgn",pic:"image/pict",pict:"image/pict",png:"image/png",pnm:"image/x-portable-anymap",pnt:"image/x-macpaint",pntg:"image/x-macpaint",ppm:"image/x-portable-pixmap",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation",potx:"application/vnd.openxmlformats-officedocument.presentationml.template",ppsx:"application/vnd.openxmlformats-officedocument.presentationml.slideshow",ppam:"application/vnd.ms-powerpoint.addin.macroEnabled.12",pptm:"application/vnd.ms-powerpoint.presentation.macroEnabled.12",potm:"application/vnd.ms-powerpoint.template.macroEnabled.12",ppsm:"application/vnd.ms-powerpoint.slideshow.macroEnabled.12",ps:"application/postscript",qt:"video/quicktime",qti:"image/x-quicktime",qtif:"image/x-quicktime",ra:"audio/x-pn-realaudio",ram:"audio/x-pn-realaudio",ras:"image/x-cmu-raster",rdf:"application/rdf+xml",rgb:"image/x-rgb",rm:"application/vnd.rn-realmedia",roff:"application/x-troff",rtf:"text/rtf",rtx:"text/richtext",sgm:"text/sgml",sgml:"text/sgml",sh:"application/x-sh",shar:"application/x-shar",silo:"model/mesh",sit:"application/x-stuffit",skd:"application/x-koan",skm:"application/x-koan",skp:"application/x-koan",skt:"application/x-koan",smi:"application/smil",smil:"application/smil",snd:"audio/basic",so:"application/octet-stream",spl:"application/x-futuresplash",src:"application/x-wais-source",sv4cpio:"application/x-sv4cpio",sv4crc:"application/x-sv4crc",svg:"image/svg+xml",swf:"application/x-shockwave-flash",t:"application/x-troff",tar:"application/x-tar",tcl:"application/x-tcl",tex:"application/x-tex",texi:"application/x-texinfo",texinfo:"application/x-texinfo",tif:"image/tiff",tiff:"image/tiff",tr:"application/x-troff",tsv:"text/tab-separated-values",txt:"text/plain",ustar:"application/x-ustar",vcd:"application/x-cdlink",vrml:"model/vrml",vxml:"application/voicexml+xml",wav:"audio/x-wav",wbmp:"image/vnd.wap.wbmp",wbmxl:"application/vnd.wap.wbxml",wml:"text/vnd.wap.wml",wmlc:"application/vnd.wap.wmlc",wmls:"text/vnd.wap.wmlscript",wmlsc:"application/vnd.wap.wmlscriptc",wrl:"model/vrml",xbm:"image/x-xbitmap",xht:"application/xhtml+xml",xhtml:"application/xhtml+xml",xls:"application/vnd.ms-excel",xml:"application/xml",xpm:"image/x-xpixmap",xsl:"application/xml",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",xltx:"application/vnd.openxmlformats-officedocument.spreadsheetml.template",xlsm:"application/vnd.ms-excel.sheet.macroEnabled.12",xltm:"application/vnd.ms-excel.template.macroEnabled.12",xlam:"application/vnd.ms-excel.addin.macroEnabled.12",xlsb:"application/vnd.ms-excel.sheet.binary.macroEnabled.12",xslt:"application/xslt+xml",xul:"application/vnd.mozilla.xul+xml",xwd:"image/x-xwindowdump",xyz:"chemical/x-xyz",zip:"application/zip"},p=function(e,i){var t=new a.Promise;if("undefined"==typeof FileReader)return a.Promise.error(new a.Error(-1,"Attempted to use a FileReader on an unsupported browser."));var n=new FileReader;return n.onloadend=function(){if(2!==n.readyState)return void t.reject(new a.Error(-1,"Error reading file."));var e=n.result,o=/^data:([^;]*);base64,(.*)$/.exec(e);return o?void t.resolve(o[2],i||o[1]):void t.reject(new a.Error(-1,"Unable to interpret data URL: "+e))},n.readAsDataURL(e),t};a.File=function(e,n,p){this._name=e,this._base64="";var r;try{r=a.User.current()}catch(l){console.warn("Get current user failed. It seems this runtime use an async storage system, please new AV.File in the callback of AV.User.currentAsync().")}this._metaData={owner:null!=r?r.id:"unknown"};var m=/\.([^.]*)$/.exec(e);m&&(m=m[1].toLowerCase());var s=p||o[m]||"text/plain";if(this._guessedType=s,_.isArray(n))this._base64=i(n),this._source=a.Promise.as(this._base64,s),this._metaData.size=n.length;else if(n&&n.base64){var c=require("./browserify-wrapper/parse-base64"),d=c(n.base64,s);this._base64=t(n.base64),this._source=a.Promise.as(d,s)}else if(n&&n.blob)this._source=a.Promise.as(n.blob,s);else if("undefined"!=typeof File&&n instanceof File)this._source=a.Promise.as(n,s);else if(a._config.isNode&&global.Buffer.isBuffer(n))this._base64=n.toString("base64"),this._source=a.Promise.as(this._base64,s),this._metaData.size=n.length;else if(_.isString(n))throw"Creating a AV.File from a String is not yet supported."},a.File.withURL=function(e,i,t,n){if(!e||!i)throw"Please provide file name and url";var o=new a.File(e,null,n);if(t)for(var p in t)o._metaData[p]||(o._metaData[p]=t[p]);return o._url=i,o._metaData.__source="external",o},a.File.createWithoutData=function(e){var i=new a.File;return i.id=e,i},a.File.prototype={toJSON:function(){return a._encode(this)},getACL:function(){return this._acl},setACL:function(e){return e instanceof a.ACL?void(this._acl=e):new a.Error(a.Error.OTHER_CAUSE,"ACL must be a AV.ACL.")},name:function(){return this._name},url:function(){return this._url},metaData:function(a,e){return null!=a&&null!=e?(this._metaData[a]=e,this):null!=a?this._metaData[a]:this._metaData},thumbnailURL:function(a,e,i,t,n){if(!this.url())throw"Invalid url.";if(!a||!e||0>=a||0>=e)throw"Invalid width or height value.";if(i=i||100,t=null==t?!0:t,0>=i||i>100)throw"Invalid quality value.";n=n||"png";var o=t?2:1;return this.url()+"?imageView/"+o+"/w/"+a+"/h/"+e+"/q/"+i+"/format/"+n},size:function(){return this.metaData().size},ownerId:function(){return this.metaData().owner},destroy:function(e){if(!this.id)return a.Promise.error("The file id is not eixsts.")._thenRunCallbacks(e);var i=a._request("files",null,this.id,"DELETE");return i._thenRunCallbacks(e)},_qiniuToken:function(e){var i=this,t=extname(i._name),n=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},o=n()+n()+n()+n()+n()+t,p={key:o,ACL:i._acl,name:i._name,mime_type:e,metaData:i._metaData};return e&&null==i._metaData.mime_type&&(i._metaData.mime_type=e),i._qiniu_key=o,a._request("qiniu",null,null,"POST",p)},save:function(){if(this.id)throw new Error("File already saved. If you want to manipulate a file, use AV.Query to get it.");var e=null,i={};1===arguments.length?e=arguments[0]:2===arguments.length&&(i=arguments[0],e=arguments[1]);var t=this;if(!t._previousSave){var o=n();if(t._source&&o){var r=require("./browserify-wrapper/upload");r(t,a,i)}else if(t._url&&"external"==t._metaData.__source){var l={name:t._name,ACL:t._acl,metaData:t._metaData,mime_type:t._guessedType,url:t._url};t._previousSave=a._request("files",t._name,null,"POST",l).then(function(a){return t._name=a.name,t._url=a.url,t.id=a.objectId,a.size&&(t._metaData.size=a.size),t})}else o||(t._previousSave=t._source.then(function(e,i){var n={base64:"",_ContentType:i,ACL:t._acl,mime_type:i,metaData:t._metaData};return t._base64?(n.base64=t._base64,a._request("files",t._name,null,"POST",n)):p(e).then(function(e){return n.base64=e,a._request("files",t._name,null,"POST",n)})}).then(function(a){return t._name=a.name,t._url=a.url,t.id=a.objectId,a.size&&(t._metaData.size=a.size),t}))}return t._previousSave._thenRunCallbacks(e)},fetch:function(){var e=null,i={};1===arguments.length?e=arguments[0]:2===arguments.length&&(i=arguments[0],e=arguments[1]);var t=this,n=a._request("files",null,this.id,"GET",i);return n.then(function(e){var i=a.Object.prototype.parse(e);return i._metaData=i.metaData||{},i._url=i.url,i._name=i.name,delete i.objectId,delete i.metaData,delete i.url,delete i.name,_.extend(t,i),t})._thenRunCallbacks(e)}}};