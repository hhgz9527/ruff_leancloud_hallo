"use strict";var _=require("underscore");module.exports=function(t){t.Query=function(n){_.isString(n)&&(n=t.Object._getSubclass(n)),this.objectClass=n,this.className=n.prototype.className,this._where={},this._include=[],this._limit=-1,this._skip=0,this._extraOptions={}},t.Query.or=function(){var n=_.toArray(arguments),e=null;t._arrayEach(n,function(t){if(_.isNull(e)&&(e=t.className),e!==t.className)throw"All queries must be for the same class"});var i=new t.Query(e);return i._orQuery(n),i},t.Query.and=function(){var n=_.toArray(arguments),e=null;t._arrayEach(n,function(t){if(_.isNull(e)&&(e=t.className),e!==t.className)throw"All queries must be for the same class"});var i=new t.Query(e);return i._andQuery(n),i},t.Query.doCloudQuery=function(n,e,i){var r={cql:n};_.isArray(e)?r.pvalues=e:i=e;var s=t._request("cloudQuery",null,null,"GET",r);return s.then(function(n){var e=new t.Query(n.className),i=_.map(n.results,function(t){var i=e._newObject(n);return i._finishFetch(e._processResult(t),!0),i});return{results:i,count:n.count,className:n.className}})._thenRunCallbacks(i)},t.Query._extend=t._extend,t.Query.prototype={_processResult:function(t){return t},get:function(n,e){if(!n){var i=new t.Error(t.Error.OBJECT_NOT_FOUND,"Object not found.");throw i}var r=this;return r.equalTo("objectId",n),r.first().then(function(n){if(!t._.isEmpty(n))return n;var e=new t.Error(t.Error.OBJECT_NOT_FOUND,"Object not found.");return t.Promise.error(e)})._thenRunCallbacks(e,null)},toJSON:function(){var n={where:this._where};return this._include.length>0&&(n.include=this._include.join(",")),this._select&&(n.keys=this._select.join(",")),this._limit>=0&&(n.limit=this._limit),this._skip>0&&(n.skip=this._skip),void 0!==this._order&&(n.order=this._order),t._objectEach(this._extraOptions,function(t,e){n[e]=t}),n},_newObject:function(n){var e;return e=n&&n.className?new t.Object(n.className):new this.objectClass},_createRequest:function(n){return t._request("classes",this.className,null,"GET",n||this.toJSON())},find:function(t){var n=this,e=this._createRequest();return e.then(function(t){return _.map(t.results,function(e){var i=n._newObject(t);return i._finishFetch(n._processResult(e),!0),i})})._thenRunCallbacks(t)},destroyAll:function(n){var e=this;return e.find().then(function(n){return t.Object.destroyAll(n)})._thenRunCallbacks(n)},count:function(t){var n=this.toJSON();n.limit=0,n.count=1;var e=this._createRequest(n);return e.then(function(t){return t.count})._thenRunCallbacks(t)},first:function(t){var n=this,e=this.toJSON();e.limit=1;var i=this._createRequest(e);return i.then(function(t){return _.map(t.results,function(t){var e=n._newObject();return e._finishFetch(n._processResult(t),!0),e})[0]})._thenRunCallbacks(t)},collection:function(n,e){return e=e||{},new t.Collection(n,_.extend(e,{model:this._objectClass||this.objectClass,query:this}))},skip:function(t){return this._skip=t,this},limit:function(t){return this._limit=t,this},equalTo:function(n,e){return this._where[n]=t._encode(e),this},_addCondition:function(n,e,i){return this._where[n]||(this._where[n]={}),this._where[n][e]=t._encode(i),this},sizeEqualTo:function(t,n){this._addCondition(t,"$size",n)},notEqualTo:function(t,n){return this._addCondition(t,"$ne",n),this},lessThan:function(t,n){return this._addCondition(t,"$lt",n),this},greaterThan:function(t,n){return this._addCondition(t,"$gt",n),this},lessThanOrEqualTo:function(t,n){return this._addCondition(t,"$lte",n),this},greaterThanOrEqualTo:function(t,n){return this._addCondition(t,"$gte",n),this},containedIn:function(t,n){return this._addCondition(t,"$in",n),this},notContainedIn:function(t,n){return this._addCondition(t,"$nin",n),this},containsAll:function(t,n){return this._addCondition(t,"$all",n),this},exists:function(t){return this._addCondition(t,"$exists",!0),this},doesNotExist:function(t){return this._addCondition(t,"$exists",!1),this},matches:function(t,n,e){return this._addCondition(t,"$regex",n),e||(e=""),n.ignoreCase&&(e+="i"),n.multiline&&(e+="m"),e&&e.length&&this._addCondition(t,"$options",e),this},matchesQuery:function(t,n){var e=n.toJSON();return e.className=n.className,this._addCondition(t,"$inQuery",e),this},doesNotMatchQuery:function(t,n){var e=n.toJSON();return e.className=n.className,this._addCondition(t,"$notInQuery",e),this},matchesKeyInQuery:function(t,n,e){var i=e.toJSON();return i.className=e.className,this._addCondition(t,"$select",{key:n,query:i}),this},doesNotMatchKeyInQuery:function(t,n,e){var i=e.toJSON();return i.className=e.className,this._addCondition(t,"$dontSelect",{key:n,query:i}),this},_orQuery:function(t){var n=_.map(t,function(t){return t.toJSON().where});return this._where.$or=n,this},_andQuery:function(t){var n=_.map(t,function(t){return t.toJSON().where});return this._where.$and=n,this},_quote:function(t){return"\\Q"+t.replace("\\E","\\E\\\\E\\Q")+"\\E"},contains:function(t,n){return this._addCondition(t,"$regex",this._quote(n)),this},startsWith:function(t,n){return this._addCondition(t,"$regex","^"+this._quote(n)),this},endsWith:function(t,n){return this._addCondition(t,"$regex",this._quote(n)+"$"),this},ascending:function(t){return this._order=t,this},addAscending:function(t){return this._order?this._order+=","+t:this._order=t,this},descending:function(t){return this._order="-"+t,this},addDescending:function(t){return this._order?this._order+=",-"+t:this._order="-"+t,t},near:function(n,e){return e instanceof t.GeoPoint||(e=new t.GeoPoint(e)),this._addCondition(n,"$nearSphere",e),this},withinRadians:function(t,n,e){return this.near(t,n),this._addCondition(t,"$maxDistance",e),this},withinMiles:function(t,n,e){return this.withinRadians(t,n,e/3958.8)},withinKilometers:function(t,n,e){return this.withinRadians(t,n,e/6371)},withinGeoBox:function(n,e,i){return e instanceof t.GeoPoint||(e=new t.GeoPoint(e)),i instanceof t.GeoPoint||(i=new t.GeoPoint(i)),this._addCondition(n,"$within",{$box:[e,i]}),this},include:function(){var n=this;return t._arrayEach(arguments,function(t){_.isArray(t)?n._include=n._include.concat(t):n._include.push(t)}),this},select:function(){var n=this;return this._select=this._select||[],t._arrayEach(arguments,function(t){_.isArray(t)?n._select=n._select.concat(t):n._select.push(t)}),this},each:function(n,e){if(e=e||{},this._order||this._skip||this._limit>=0){var i="Cannot iterate on a query with sort, skip, or limit.";return t.Promise.error(i)._thenRunCallbacks(e)}var r=(new t.Promise,new t.Query(this.objectClass));r._limit=e.batchSize||100,r._where=_.clone(this._where),r._include=_.clone(this._include),r.ascending("objectId");var s=!1;return t.Promise._continueWhile(function(){return!s},function(){return r.find().then(function(e){var i=t.Promise.as();return t._.each(e,function(t){i=i.then(function(){return n(t)})}),i.then(function(){e.length>=r._limit?r.greaterThan("objectId",e[e.length-1].id):s=!0})})})._thenRunCallbacks(e)}},t.FriendShipQuery=t.Query._extend({_objectClass:t.User,_newObject:function(){return new t.User},_processResult:function(t){if(t&&t[this._friendshipTag]){var n=t[this._friendshipTag];return"Pointer"===n.__type&&"_User"===n.className&&(delete n.__type,delete n.className),n}return null}})};